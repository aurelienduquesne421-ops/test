<!DOCTYPE html>
<html>
<head>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">

import { useState, useEffect, useCallback } from "react";

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const generateId = () => Date.now().toString(36) + Math.random().toString(36).slice(2);
const now = () => new Date().toISOString();
const formatDT = (iso) => {
  if (!iso) return "‚Äî";
  const d = new Date(iso);
  return d.toLocaleString("fr-FR", { dateStyle: "short", timeStyle: "short" });
};

// ‚îÄ‚îÄ‚îÄ Initial seed data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SEED_EQUIPMENT = [
  { id: "EQ001", name: "R√©acteur R-101", location: "Salle A - Zone 1", type: "production", status: "op√©rationnel", createdAt: now() },
  { id: "EQ002", name: "HPLC Agilent 1260", location: "Laboratoire CQ", type: "QC", status: "op√©rationnel", createdAt: now() },
  { id: "EQ003", name: "Autoclave AUT-01", location: "Salle B - Zone 2", type: "utilit√©s", status: "maintenance", createdAt: now() },
];
const SEED_ROOMS = [
  { id: "RM001", name: "Salle A - Production", classification: "Grade C", status: "op√©rationnelle", createdAt: now() },
  { id: "RM002", name: "Laboratoire CQ", classification: "Grade D", status: "op√©rationnelle", createdAt: now() },
];
const SEED_USERS = [
  { id: "U01", name: "Marie Dupont", role: "operator", password: "op123" },
  { id: "U02", name: "Jean Martin", role: "maintenance", password: "mt123" },
  { id: "U03", name: "Sophie Bernard", role: "quality", password: "qa123" },
  { id: "U04", name: "Admin Sys", role: "admin", password: "admin123" },
];

const ACTIVITY_TYPES = ["utilisation", "nettoyage", "maintenance", "calibration", "incident", "intervention technique"];
const ROLES_LABEL = { operator: "Op√©rateur", maintenance: "Maintenance", quality: "Qualit√©", admin: "Administrateur" };
const STATUS_COLORS = {
  op√©rationnel: "bg-green-100 text-green-800",
  op√©rationnelle: "bg-green-100 text-green-800",
  maintenance: "bg-yellow-100 text-yellow-800",
  "hors service": "bg-red-100 text-red-800",
  "en attente": "bg-blue-100 text-blue-800",
};

// ‚îÄ‚îÄ‚îÄ Storage helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const useStore = (key, initial) => {
  const [state, setState] = useState(() => {
    try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : initial; } catch { return initial; }
  });
  const set = useCallback((v) => {
    setState(prev => {
      const next = typeof v === "function" ? v(prev) : v;
      try { localStorage.setItem(key, JSON.stringify(next)); } catch {}
      return next;
    });
  }, [key]);
  return [state, set];
};

// ‚îÄ‚îÄ‚îÄ Components ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Badge = ({ label, className = "" }) => (
  <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${className}`}>{label}</span>
);

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-gray-100 ${className}`}>{children}</div>
);

const Modal = ({ title, onClose, children }) => (
  <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
      <div className="flex items-center justify-between px-6 py-4 border-b">
        <h2 className="font-bold text-gray-800 text-lg">{title}</h2>
        <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
      </div>
      <div className="p-6">{children}</div>
    </div>
  </div>
);

const Input = ({ label, ...props }) => (
  <div className="mb-4">
    {label && <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
    <input className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" {...props} />
  </div>
);

const Select = ({ label, options, ...props }) => (
  <div className="mb-4">
    {label && <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
    <select className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" {...props}>
      {options.map(o => <option key={o.value ?? o} value={o.value ?? o}>{o.label ?? o}</option>)}
    </select>
  </div>
);

const Textarea = ({ label, ...props }) => (
  <div className="mb-4">
    {label && <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
    <textarea className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" rows={3} {...props} />
  </div>
);

// ‚îÄ‚îÄ‚îÄ Login Screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function LoginScreen({ users, onLogin }) {
  const [userId, setUserId] = useState(users[0].id);
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [lastActivity, setLastActivity] = useState(null);

  const handleLogin = () => {
    const user = users.find(u => u.id === userId);
    if (!user || user.password !== password) { setError("Identifiants incorrects."); return; }
    onLogin(user);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-900 to-blue-700 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8">
        <div className="text-center mb-6">
          <div className="text-4xl mb-2">üìã</div>
          <h1 className="text-2xl font-bold text-gray-900">GMP Logbook</h1>
          <p className="text-sm text-gray-500 mt-1">Syst√®me de gestion des logbooks GMP</p>
        </div>
        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-700 mb-1">Utilisateur</label>
          <select className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" value={userId} onChange={e => setUserId(e.target.value)}>
            {users.map(u => <option key={u.id} value={u.id}>{u.name} ({ROLES_LABEL[u.role]})</option>)}
          </select>
        </div>
        <Input label="Mot de passe" type="password" value={password} onChange={e => { setPassword(e.target.value); setError(""); }} onKeyDown={e => e.key === "Enter" && handleLogin()} placeholder="Entrez votre mot de passe" />
        {error && <p className="text-red-500 text-sm mb-3">{error}</p>}
        <button onClick={handleLogin} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 rounded-lg transition-colors">
          Se connecter
        </button>
        <p className="text-xs text-gray-400 mt-4 text-center">Mots de passe d√©mo : op123 / mt123 / qa123 / admin123</p>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Entry Form ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function EntryForm({ currentUser, target, targetType, onSave, onClose, editEntry }) {
  const [activity, setActivity] = useState(editEntry?.activity || ACTIVITY_TYPES[0]);
  const [comment, setComment] = useState(editEntry?.comment || "");
  const [sigPassword, setSigPassword] = useState("");
  const [sigError, setSigError] = useState("");
  const [editReason, setEditReason] = useState("");

  const needsSig = ["nettoyage", "calibration", "maintenance"].includes(activity);

  const handleSave = () => {
    if (needsSig && sigPassword !== currentUser.password) { setSigError("Mot de passe incorrect ‚Äì signature √©lectronique refus√©e."); return; }
    if (editEntry && !editReason.trim()) { setSigError("Une raison de modification est obligatoire."); return; }
    const entry = {
      id: editEntry?.id || generateId(),
      targetId: target.id,
      targetName: target.name,
      targetType,
      activity,
      comment,
      userId: currentUser.id,
      userName: currentUser.name,
      userRole: currentUser.role,
      createdAt: editEntry?.createdAt || now(),
      status: "draft",
      signed: needsSig && sigPassword === currentUser.password,
      editHistory: editEntry ? [...(editEntry.editHistory || []), { by: currentUser.name, at: now(), reason: editReason, oldComment: editEntry.comment, oldActivity: editEntry.activity }] : [],
    };
    onSave(entry);
    onClose();
  };

  return (
    <Modal title={editEntry ? "Modifier une entr√©e" : "Nouvelle entr√©e logbook"} onClose={onClose}>
      <Select label="Type d'activit√©" value={activity} onChange={e => setActivity(e.target.value)} options={ACTIVITY_TYPES} />
      <Textarea label="Commentaire" value={comment} onChange={e => setComment(e.target.value)} placeholder="D√©crivez l'activit√© r√©alis√©e..." />
      <div className="mb-3 p-3 bg-gray-50 rounded-lg text-sm text-gray-600">
        <strong>√âquipement/Salle :</strong> {target.name}<br />
        <strong>Saisi par :</strong> {currentUser.name} ({ROLES_LABEL[currentUser.role]})<br />
        <strong>Horodatage :</strong> {formatDT(now())}
      </div>
      {editEntry && (
        <Input label="Raison de la modification (obligatoire)" value={editReason} onChange={e => setEditReason(e.target.value)} placeholder="Correction erreur de saisie..." />
      )}
      {needsSig && (
        <div>
          <Input label={`Signature √©lectronique ‚Äì confirmez votre mot de passe`} type="password" value={sigPassword} onChange={e => { setSigPassword(e.target.value); setSigError(""); }} placeholder="Votre mot de passe" />
          <p className="text-xs text-blue-600 -mt-2 mb-3">‚ö†Ô∏è Signature √©lectronique requise pour cette activit√© (Annex 11 / 21 CFR Part 11)</p>
        </div>
      )}
      {sigError && <p className="text-red-500 text-sm mb-3">{sigError}</p>}
      <div className="flex gap-3">
        <button onClick={handleSave} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition-colors">
          {editEntry ? "Enregistrer la modification" : "Enregistrer l'entr√©e"}
        </button>
        <button onClick={onClose} className="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 rounded-lg transition-colors">Annuler</button>
      </div>
    </Modal>
  );
}

// ‚îÄ‚îÄ‚îÄ Logbook View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function LogbookView({ target, targetType, entries, currentUser, onNewEntry, onEditEntry, onApprove, onClose }) {
  const [filter, setFilter] = useState({ activity: "", status: "", search: "" });
  const targetEntries = entries.filter(e => e.targetId === target.id);

  const filtered = targetEntries.filter(e => {
    if (filter.activity && e.activity !== filter.activity) return false;
    if (filter.status && e.status !== filter.status) return false;
    if (filter.search && !e.comment.toLowerCase().includes(filter.search.toLowerCase()) && !e.userName.toLowerCase().includes(filter.search.toLowerCase())) return false;
    return true;
  });

  const canApprove = currentUser.role === "quality" || currentUser.role === "admin";
  const canEdit = currentUser.role !== "quality";

  return (
    <Modal title={`Logbook ‚Äì ${target.name}`} onClose={onClose}>
      <div className="flex flex-wrap gap-2 mb-4">
        <select className="border border-gray-200 rounded-lg px-2 py-1 text-xs" value={filter.activity} onChange={e => setFilter(f => ({ ...f, activity: e.target.value }))}>
          <option value="">Toutes activit√©s</option>
          {ACTIVITY_TYPES.map(a => <option key={a} value={a}>{a}</option>)}
        </select>
        <select className="border border-gray-200 rounded-lg px-2 py-1 text-xs" value={filter.status} onChange={e => setFilter(f => ({ ...f, status: e.target.value }))}>
          <option value="">Tous statuts</option>
          <option value="draft">Brouillon</option>
          <option value="approved">Approuv√©</option>
        </select>
        <input className="border border-gray-200 rounded-lg px-2 py-1 text-xs flex-1 min-w-24" placeholder="Rechercher..." value={filter.search} onChange={e => setFilter(f => ({ ...f, search: e.target.value }))} />
      </div>

      {canEdit && (
        <button onClick={() => onNewEntry(target, targetType)} className="w-full mb-4 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 rounded-lg transition-colors">
          + Nouvelle entr√©e
        </button>
      )}

      <div className="space-y-3 max-h-80 overflow-y-auto pr-1">
        {filtered.length === 0 && <p className="text-gray-400 text-sm text-center py-4">Aucune entr√©e trouv√©e.</p>}
        {filtered.slice().reverse().map(entry => (
          <div key={entry.id} className="border border-gray-100 rounded-xl p-3 bg-gray-50">
            <div className="flex items-start justify-between gap-2">
              <div className="flex-1">
                <div className="flex items-center gap-2 flex-wrap mb-1">
                  <span className="text-xs font-bold text-blue-700 uppercase tracking-wide">{entry.activity}</span>
                  <Badge label={entry.status === "approved" ? "‚úì Approuv√©" : "Brouillon"} className={entry.status === "approved" ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800"} />
                  {entry.signed && <Badge label="‚úç Sign√©" className="bg-purple-100 text-purple-800" />}
                </div>
                <p className="text-sm text-gray-800">{entry.comment || <em className="text-gray-400">Aucun commentaire</em>}</p>
                <div className="text-xs text-gray-500 mt-1">{entry.userName} ¬∑ {formatDT(entry.createdAt)}</div>
                {entry.editHistory?.length > 0 && (
                  <details className="mt-1">
                    <summary className="text-xs text-orange-600 cursor-pointer">üìù {entry.editHistory.length} modification(s)</summary>
                    {entry.editHistory.map((h, i) => (
                      <div key={i} className="text-xs bg-orange-50 border border-orange-100 rounded p-2 mt-1">
                        <strong>{h.by}</strong> ¬∑ {formatDT(h.at)}<br />
                        Raison : {h.reason}<br />
                        Ancienne valeur : {h.oldActivity} ‚Äì {h.oldComment}
                      </div>
                    ))}
                  </details>
                )}
              </div>
              <div className="flex flex-col gap-1">
                {canEdit && entry.status !== "approved" && entry.userId === currentUser.id && (
                  <button onClick={() => onEditEntry(entry)} className="text-xs bg-blue-50 hover:bg-blue-100 text-blue-700 px-2 py-1 rounded-lg">Modifier</button>
                )}
                {canApprove && entry.status !== "approved" && (
                  <button onClick={() => onApprove(entry.id)} className="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-2 py-1 rounded-lg">Approuver</button>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>

      <div className="mt-4 pt-3 border-t text-xs text-gray-500 flex justify-between">
        <span>{filtered.length} entr√©e(s)</span>
        <span>{filtered.filter(e => e.status === "approved").length} approuv√©e(s)</span>
      </div>
    </Modal>
  );
}

// ‚îÄ‚îÄ‚îÄ Audit Trail ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function AuditTrailView({ auditLog, onClose }) {
  const [search, setSearch] = useState("");
  const filtered = auditLog.filter(l =>
    l.action.toLowerCase().includes(search.toLowerCase()) ||
    l.by.toLowerCase().includes(search.toLowerCase()) ||
    (l.detail || "").toLowerCase().includes(search.toLowerCase())
  ).slice().reverse();

  return (
    <Modal title="Audit Trail ‚Äì Journal complet" onClose={onClose}>
      <input className="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm mb-4" placeholder="Rechercher..." value={search} onChange={e => setSearch(e.target.value)} />
      <div className="space-y-2 max-h-96 overflow-y-auto">
        {filtered.map((log, i) => (
          <div key={i} className="flex gap-3 text-xs border-b border-gray-50 pb-2">
            <div className="text-gray-400 whitespace-nowrap">{formatDT(log.at)}</div>
            <div>
              <span className={`font-semibold ${log.action.includes("suppression") ? "text-red-600" : log.action.includes("modification") ? "text-orange-600" : "text-blue-700"}`}>{log.action}</span>
              <span className="text-gray-600"> ¬∑ {log.by}</span>
              {log.detail && <div className="text-gray-500">{log.detail}</div>}
            </div>
          </div>
        ))}
        {filtered.length === 0 && <p className="text-gray-400 text-sm text-center py-4">Aucun √©v√©nement.</p>}
      </div>
      <p className="text-xs text-gray-400 mt-3 text-center">Audit trail immuable ‚Äì conforme Annex 11 / ALCOA+</p>
    </Modal>
  );
}

// ‚îÄ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportCSV(entries) {
  const headers = ["ID", "Cible", "Type", "Activit√©", "Commentaire", "Utilisateur", "R√¥le", "Date/Heure", "Statut", "Sign√©"];
  const rows = entries.map(e => [e.id, e.targetName, e.targetType, e.activity, `"${e.comment.replace(/"/g, '""')}"`, e.userName, e.userRole, e.createdAt, e.status, e.signed ? "oui" : "non"]);
  const csv = [headers, ...rows].map(r => r.join(";")).join("\n");
  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = `logbook_export_${Date.now()}.csv`; a.click();
}

// ‚îÄ‚îÄ‚îÄ Main App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export default function App() {
  const [users] = useStore("gmp_users", SEED_USERS);
  const [equipment, setEquipment] = useStore("gmp_equipment", SEED_EQUIPMENT);
  const [rooms, setRooms] = useStore("gmp_rooms", SEED_ROOMS);
  const [entries, setEntries] = useStore("gmp_entries", []);
  const [auditLog, setAuditLog] = useStore("gmp_audit", []);
  const [currentUser, setCurrentUser] = useState(null);
  const [activeTab, setActiveTab] = useState("equipment");
  const [modal, setModal] = useState(null); // { type, ... }
  const [inactivityTimer, setInactivityTimer] = useState(null);

  // Inactivity lock (15 min)
  const resetTimer = useCallback(() => {
    if (inactivityTimer) clearTimeout(inactivityTimer);
    const t = setTimeout(() => { setCurrentUser(null); }, 15 * 60 * 1000);
    setInactivityTimer(t);
  }, [inactivityTimer]);

  useEffect(() => {
    if (!currentUser) return;
    window.addEventListener("mousemove", resetTimer);
    window.addEventListener("keydown", resetTimer);
    resetTimer();
    return () => { window.removeEventListener("mousemove", resetTimer); window.removeEventListener("keydown", resetTimer); };
  }, [currentUser]);

  const addAudit = (action, by, detail = "") => {
    setAuditLog(prev => [...prev, { action, by, at: now(), detail }]);
  };

  const handleLogin = (user) => {
    setCurrentUser(user);
    addAudit("connexion", user.name);
  };

  const handleLogout = () => {
    addAudit("d√©connexion", currentUser.name);
    setCurrentUser(null);
    setModal(null);
  };

  const handleSaveEntry = (entry) => {
    setEntries(prev => {
      const existing = prev.findIndex(e => e.id === entry.id);
      if (existing >= 0) {
        const updated = [...prev]; updated[existing] = entry;
        addAudit("modification entr√©e", currentUser.name, `${entry.targetName} ‚Äì ${entry.activity}`);
        return updated;
      }
      addAudit("cr√©ation entr√©e", currentUser.name, `${entry.targetName} ‚Äì ${entry.activity}`);
      return [...prev, entry];
    });
  };

  const handleApprove = (entryId) => {
    setEntries(prev => prev.map(e => e.id === entryId ? { ...e, status: "approved", approvedBy: currentUser.name, approvedAt: now() } : e));
    addAudit("approbation entr√©e", currentUser.name, `Entr√©e ${entryId}`);
  };

  const handleAddEquipment = (eq) => {
    setEquipment(prev => [...prev, { ...eq, id: generateId(), createdAt: now() }]);
    addAudit("cr√©ation √©quipement", currentUser.name, eq.name);
  };

  const handleAddRoom = (room) => {
    setRooms(prev => [...prev, { ...room, id: generateId(), createdAt: now() }]);
    addAudit("cr√©ation salle", currentUser.name, room.name);
  };

  // Stats
  const totalEntries = entries.length;
  const pendingApproval = entries.filter(e => e.status !== "approved").length;
  const todayEntries = entries.filter(e => new Date(e.createdAt).toDateString() === new Date().toDateString()).length;

  if (!currentUser) return <LoginScreen users={users} onLogin={handleLogin} />;

  const canAdmin = currentUser.role === "admin";
  const canQA = currentUser.role === "quality" || canAdmin;

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      {/* Header */}
      <header className="bg-blue-800 text-white px-4 py-3 flex items-center justify-between shadow-lg">
        <div className="flex items-center gap-3">
          <span className="text-2xl">üìã</span>
          <div>
            <h1 className="font-bold text-lg leading-tight">GMP Logbook System</h1>
            <p className="text-blue-300 text-xs">Conforme Annex 11 ¬∑ ALCOA+ ¬∑ 21 CFR Part 11</p>
          </div>
        </div>
        <div className="flex items-center gap-3">
          <div className="text-right hidden sm:block">
            <p className="text-sm font-semibold">{currentUser.name}</p>
            <p className="text-blue-300 text-xs">{ROLES_LABEL[currentUser.role]}</p>
          </div>
          <button onClick={handleLogout} className="bg-blue-700 hover:bg-blue-600 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors">D√©connexion</button>
        </div>
      </header>

      {/* KPI Bar */}
      <div className="bg-white border-b px-4 py-3 flex gap-4 overflow-x-auto">
        {[
          { label: "Total entr√©es", value: totalEntries, color: "text-blue-700" },
          { label: "En attente QA", value: pendingApproval, color: pendingApproval > 0 ? "text-orange-600" : "text-green-600" },
          { label: "Aujourd'hui", value: todayEntries, color: "text-purple-600" },
          { label: "√âquipements", value: equipment.length, color: "text-gray-700" },
          { label: "Salles", value: rooms.length, color: "text-gray-700" },
        ].map(k => (
          <div key={k.label} className="text-center min-w-20">
            <div className={`text-2xl font-bold ${k.color}`}>{k.value}</div>
            <div className="text-xs text-gray-500">{k.label}</div>
          </div>
        ))}
      </div>

      {/* Tabs */}
      <nav className="bg-white border-b px-4 flex gap-1 overflow-x-auto">
        {[
          { id: "equipment", label: "üîß √âquipements" },
          { id: "rooms", label: "üè≠ Salles" },
          ...(canQA ? [{ id: "review", label: "‚úÖ Revue QA" }] : []),
          { id: "audit", label: "üìú Audit Trail" },
          ...(canAdmin ? [{ id: "admin", label: "‚öôÔ∏è Administration" }] : []),
        ].map(tab => (
          <button key={tab.id} onClick={() => setActiveTab(tab.id)}
            className={`px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition-colors ${activeTab === tab.id ? "border-blue-600 text-blue-700" : "border-transparent text-gray-500 hover:text-gray-700"}`}>
            {tab.label}
          </button>
        ))}
        <button onClick={() => exportCSV(entries)} className="ml-auto px-4 py-3 text-sm font-medium text-gray-500 hover:text-green-600 whitespace-nowrap">‚¨á Export CSV</button>
      </nav>

      {/* Content */}
      <main className="flex-1 p-4 max-w-5xl mx-auto w-full">

        {/* EQUIPMENT TAB */}
        {activeTab === "equipment" && (
          <div>
            <div className="flex items-center justify-between mb-4">
              <h2 className="font-bold text-gray-800 text-lg">Logbooks √âquipements</h2>
              {canAdmin && <button onClick={() => setModal({ type: "addEq" })} className="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold px-4 py-2 rounded-lg">+ Ajouter</button>}
            </div>
            <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
              {equipment.map(eq => {
                const eqEntries = entries.filter(e => e.targetId === eq.id);
                const pending = eqEntries.filter(e => e.status !== "approved").length;
                return (
                  <Card key={eq.id} className="p-4 hover:shadow-md transition-shadow cursor-pointer" onClick={() => setModal({ type: "logbook", target: eq, targetType: "equipment" })}>
                    <div className="flex items-start justify-between mb-2">
                      <h3 className="font-semibold text-gray-900 text-sm">{eq.name}</h3>
                      <Badge label={eq.status} className={STATUS_COLORS[eq.status] || "bg-gray-100 text-gray-700"} />
                    </div>
                    <p className="text-xs text-gray-500 mb-1">üìç {eq.location}</p>
                    <p className="text-xs text-gray-400 mb-3">ID: {eq.id} ¬∑ Type: {eq.type}</p>
                    <div className="flex items-center justify-between text-xs">
                      <span className="text-gray-500">{eqEntries.length} entr√©e(s)</span>
                      {pending > 0 && <Badge label={`${pending} en attente`} className="bg-orange-100 text-orange-700" />}
                    </div>
                  </Card>
                );
              })}
            </div>
          </div>
        )}

        {/* ROOMS TAB */}
        {activeTab === "rooms" && (
          <div>
            <div className="flex items-center justify-between mb-4">
              <h2 className="font-bold text-gray-800 text-lg">Logbooks Salles & Zones</h2>
              {canAdmin && <button onClick={() => setModal({ type: "addRoom" })} className="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold px-4 py-2 rounded-lg">+ Ajouter</button>}
            </div>
            <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
              {rooms.map(room => {
                const roomEntries = entries.filter(e => e.targetId === room.id);
                const pending = roomEntries.filter(e => e.status !== "approved").length;
                return (
                  <Card key={room.id} className="p-4 hover:shadow-md transition-shadow cursor-pointer" onClick={() => setModal({ type: "logbook", target: room, targetType: "room" })}>
                    <div className="flex items-start justify-between mb-2">
                      <h3 className="font-semibold text-gray-900 text-sm">{room.name}</h3>
                      <Badge label={room.status} className={STATUS_COLORS[room.status] || "bg-gray-100 text-gray-700"} />
                    </div>
                    <p className="text-xs text-gray-500 mb-1">üè∑ Classification: {room.classification}</p>
                    <p className="text-xs text-gray-400 mb-3">ID: {room.id}</p>
                    <div className="flex items-center justify-between text-xs">
                      <span className="text-gray-500">{roomEntries.length} entr√©e(s)</span>
                      {pending > 0 && <Badge label={`${pending} en attente`} className="bg-orange-100 text-orange-700" />}
                    </div>
                  </Card>
                );
              })}
            </div>
          </div>
        )}

        {/* QA REVIEW TAB */}
        {activeTab === "review" && canQA && (
          <div>
            <h2 className="font-bold text-gray-800 text-lg mb-4">Revue Qualit√© ‚Äì Entr√©es en attente</h2>
            <div className="space-y-3">
              {entries.filter(e => e.status !== "approved").length === 0 && (
                <Card className="p-8 text-center text-gray-400">
                  <div className="text-4xl mb-2">‚úÖ</div>
                  <p>Toutes les entr√©es sont approuv√©es.</p>
                </Card>
              )}
              {entries.filter(e => e.status !== "approved").slice().reverse().map(entry => (
                <Card key={entry.id} className="p-4">
                  <div className="flex items-start justify-between gap-4">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1 flex-wrap">
                        <span className="font-semibold text-gray-900 text-sm">{entry.targetName}</span>
                        <Badge label={entry.activity} className="bg-blue-100 text-blue-700" />
                        {entry.signed && <Badge label="‚úç Sign√©" className="bg-purple-100 text-purple-800" />}
                      </div>
                      <p className="text-sm text-gray-700 mb-1">{entry.comment || <em className="text-gray-400">Aucun commentaire</em>}</p>
                      <p className="text-xs text-gray-500">{entry.userName} ¬∑ {formatDT(entry.createdAt)}</p>
                    </div>
                    <button onClick={() => handleApprove(entry.id)} className="bg-green-600 hover:bg-green-700 text-white text-sm font-semibold px-4 py-2 rounded-lg whitespace-nowrap transition-colors">
                      ‚úì Approuver
                    </button>
                  </div>
                </Card>
              ))}
            </div>
          </div>
        )}

        {/* AUDIT TRAIL TAB */}
        {activeTab === "audit" && (
          <div>
            <h2 className="font-bold text-gray-800 text-lg mb-4">Audit Trail</h2>
            <Card className="p-4">
              <AuditTrailView auditLog={auditLog} onClose={() => {}} inline />
              {/* inline version without modal */}
              <div className="space-y-2 max-h-[500px] overflow-y-auto">
                {auditLog.slice().reverse().map((log, i) => (
                  <div key={i} className="flex gap-3 text-xs border-b border-gray-50 pb-2">
                    <div className="text-gray-400 whitespace-nowrap">{formatDT(log.at)}</div>
                    <div>
                      <span className={`font-semibold ${log.action.includes("suppression") ? "text-red-600" : log.action.includes("modification") ? "text-orange-600" : log.action.includes("approbation") ? "text-green-600" : "text-blue-700"}`}>{log.action}</span>
                      <span className="text-gray-600"> ¬∑ {log.by}</span>
                      {log.detail && <div className="text-gray-500">{log.detail}</div>}
                    </div>
                  </div>
                ))}
                {auditLog.length === 0 && <p className="text-gray-400 text-sm text-center py-4">Aucun √©v√©nement enregistr√©.</p>}
              </div>
              <p className="text-xs text-gray-400 mt-3 text-center pt-2 border-t">Audit trail immuable ‚Äì Annex 11 ¬ß9 ¬∑ ALCOA+</p>
            </Card>
          </div>
        )}

        {/* ADMIN TAB */}
        {activeTab === "admin" && canAdmin && (
          <div className="space-y-6">
            <h2 className="font-bold text-gray-800 text-lg">Administration syst√®me</h2>
            <Card className="p-4">
              <h3 className="font-semibold text-gray-700 mb-3">üë• Utilisateurs</h3>
              <table className="w-full text-sm">
                <thead><tr className="text-xs text-gray-500 border-b"><th className="text-left pb-2">ID</th><th className="text-left pb-2">Nom</th><th className="text-left pb-2">R√¥le</th></tr></thead>
                <tbody>{users.map(u => (
                  <tr key={u.id} className="border-b border-gray-50">
                    <td className="py-2 text-gray-400 text-xs">{u.id}</td>
                    <td className="py-2">{u.name}</td>
                    <td className="py-2"><Badge label={ROLES_LABEL[u.role]} className="bg-blue-100 text-blue-700" /></td>
                  </tr>
                ))}</tbody>
              </table>
            </Card>
            <Card className="p-4">
              <h3 className="font-semibold text-gray-700 mb-3">üìä Statistiques syst√®me</h3>
              <div className="grid grid-cols-2 gap-3 text-sm">
                {[
                  ["Total entr√©es", entries.length],
                  ["Entr√©es approuv√©es", entries.filter(e => e.status === "approved").length],
                  ["Entr√©es sign√©es", entries.filter(e => e.signed).length],
                  ["√âv√©nements audit", auditLog.length],
                ].map(([label, val]) => (
                  <div key={label} className="bg-gray-50 rounded-lg p-3">
                    <div className="text-2xl font-bold text-blue-700">{val}</div>
                    <div className="text-xs text-gray-500">{label}</div>
                  </div>
                ))}
              </div>
            </Card>
            <Card className="p-4">
              <h3 className="font-semibold text-gray-700 mb-3">üîê Conformit√©</h3>
              <div className="space-y-2 text-sm">
                {[
                  ["EU GMP Annex 11", "‚úÖ Conforme"],
                  ["21 CFR Part 11 (sig. √©lec.)", "‚úÖ Conforme"],
                  ["ALCOA+", "‚úÖ Conforme"],
                  ["Audit trail", "‚úÖ Actif & immuable"],
                  ["Gestion des r√¥les", "‚úÖ Active"],
                  ["Verrouillage inactivit√©", "‚úÖ 15 min"],
                ].map(([label, val]) => (
                  <div key={label} className="flex justify-between items-center py-1 border-b border-gray-50">
                    <span className="text-gray-600">{label}</span>
                    <span className="text-green-600 font-medium text-xs">{val}</span>
                  </div>
                ))}
              </div>
            </Card>
          </div>
        )}
      </main>

      {/* Modals */}
      {modal?.type === "logbook" && (
        <LogbookView
          target={modal.target}
          targetType={modal.targetType}
          entries={entries}
          currentUser={currentUser}
          onNewEntry={(t, tt) => setModal({ type: "entry", target: t, targetType: tt })}
          onEditEntry={(entry) => setModal({ type: "editEntry", entry, target: { id: entry.targetId, name: entry.targetName }, targetType: entry.targetType })}
          onApprove={handleApprove}
          onClose={() => setModal(null)}
        />
      )}

      {modal?.type === "entry" && (
        <EntryForm
          currentUser={currentUser}
          target={modal.target}
          targetType={modal.targetType}
          onSave={handleSaveEntry}
          onClose={() => setModal(null)}
        />
      )}

      {modal?.type === "editEntry" && (
        <EntryForm
          currentUser={currentUser}
          target={modal.target}
          targetType={modal.targetType}
          editEntry={modal.entry}
          onSave={handleSaveEntry}
          onClose={() => setModal(null)}
        />
      )}

      {modal?.type === "addEq" && <AddEquipmentModal onSave={handleAddEquipment} onClose={() => setModal(null)} />}
      {modal?.type === "addRoom" && <AddRoomModal onSave={handleAddRoom} onClose={() => setModal(null)} />}

      {/* Footer */}
      <footer className="text-center text-xs text-gray-400 py-3 border-t bg-white">
        GMP Logbook System ¬∑ Conforme EU GMP Annex 11 ¬∑ ALCOA+ ¬∑ 21 CFR Part 11 ¬∑ GAMP5
      </footer>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Add Equipment Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function AddEquipmentModal({ onSave, onClose }) {
  const [form, setForm] = useState({ name: "", location: "", type: "production", status: "op√©rationnel" });
  const set = (k, v) => setForm(f => ({ ...f, [k]: v }));
  return (
    <Modal title="Ajouter un √©quipement" onClose={onClose}>
      <Input label="Nom de l'√©quipement" value={form.name} onChange={e => set("name", e.target.value)} placeholder="Ex: R√©acteur R-102" />
      <Input label="Localisation" value={form.location} onChange={e => set("location", e.target.value)} placeholder="Ex: Salle B - Zone 1" />
      <Select label="Type" value={form.type} onChange={e => set("type", e.target.value)} options={["production", "QC", "utilit√©s"]} />
      <Select label="Statut" value={form.status} onChange={e => set("status", e.target.value)} options={["op√©rationnel", "maintenance", "hors service"]} />
      <div className="flex gap-3">
        <button onClick={() => { if (form.name) { onSave(form); onClose(); } }} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg">Ajouter</button>
        <button onClick={onClose} className="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 rounded-lg">Annuler</button>
      </div>
    </Modal>
  );
}

// ‚îÄ‚îÄ‚îÄ Add Room Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function AddRoomModal({ onSave, onClose }) {
  const [form, setForm] = useState({ name: "", classification: "Grade D", status: "op√©rationnelle" });
  const set = (k, v) => setForm(f => ({ ...f, [k]: v }));
  return (
    <Modal title="Ajouter une salle" onClose={onClose}>
      <Input label="Nom de la salle" value={form.name} onChange={e => set("name", e.target.value)} placeholder="Ex: Salle C - Zone 3" />
      <Select label="Classification" value={form.classification} onChange={e => set("classification", e.target.value)} options={["Grade A", "Grade B", "Grade C", "Grade D", "Non class√©e"]} />
      <Select label="Statut" value={form.status} onChange={e => set("status", e.target.value)} options={["op√©rationnelle", "maintenance", "hors service"]} />
      <div className="flex gap-3">
        <button onClick={() => { if (form.name) { onSave(form); onClose(); } }} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg">Ajouter</button>
        <button onClick={onClose} className="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 rounded-lg">Annuler</button>
      </div>
    </Modal>
  );
}


ReactDOM.createRoot(document.getElementById('root')).render(<App />);

</script>

</body>
</html>